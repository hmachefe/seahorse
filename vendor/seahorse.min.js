/*! seahorse - v0.0.8 - 2014-10-15 */
!function(a){"use strict";var b=require("fs"),c=require("throttle"),d=require("util"),e={_debug:!1,_getExtension:function(a){var b=a.lastIndexOf(".");return 0>b?"":a.substr(b)},_sendfile:function(a,f,g){var h=b.createReadStream(a),i=new c(g);h.on("open",function(){e._debug&&d.log("open "+a),h.pipe(i).pipe(f)}),h.on("data",function(a){e._debug&&d.log("read a chunk  :"+a.length+" bytes")}),h.on("close",function(){e._debug&&d.log("closed "+a)}),h.on("error",function(a){console.log("error from reading stream "+a.toString()),f.end(a)})},_allowCrossDomain:function(a,b,c){b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE"),b.header("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"==a.method?b.send(200):c()}};a.utils=e}(this),function(a,b){"use strict";var c=require("util"),d={config:[],checkConfig:function(a){try{{JSON.stringify(a)}if(!1==a instanceof Array)throw"object is not an array";a.forEach(function(a,b){if("undefined"==typeof a.httpRequest||"undefined"==typeof a.httpResponse)throw"["+b+"] httpResponse or httpRequest missing";if("undefined"==typeof a.httpRequest.method||"undefined"==typeof a.httpRequest.path)throw"["+b+"] method or path is missing in httpRequest key";if("undefined"==typeof a.httpResponse.statusCode)throw"["+b+"] statusCode is missing in httpResponse key";if("GET"===a.httpRequest.method.toUpperCase()&&"undefined"==typeof a.httpResponse.body&&"undefined"==typeof a.httpResponse.file&&"undefined"==typeof a.httpResponse.static)throw"["+b+"] body, file or static are missing in httpResponse key (GET "+a.httpRequest.path+")"})}catch(b){return c.log("error: input file is not a valid json config file, "+b),!1}return!0},setConfig:function(a){return this.checkConfig(a)?(this.config=a,!0):!1},updateConfig:function(a){var b=this;return this.checkConfig(a)?(a.forEach(function(a){var c=b.config.every(function(b){return b.httpRequest.path===a.httpRequest.path&&b.httpRequest.method===a.httpRequest.method&&b.httpRequest.query===a.httpRequest.query?(b.httpResponse=a.httpResponse,!1):!0});c===!0&&b.config.push(a)}),!0):!1},getConfig:function(){return this.config},_matchPath:function(a,b){if(c.log(">>>> match ? "+b.params[0]+" vs "+a.httpRequest.path),c.log(">>>> match ? "+b.method.toUpperCase()+" vs "+a.httpRequest.method.toUpperCase()),a.httpRequest.method.toUpperCase()!==b.method.toUpperCase())return c.log(">>>> NO, methods differ"),!1;if(/^regexp:/.test(a.httpRequest.path)){var d=new RegExp(a.httpRequest.path.split(":")[1]);if(d.test(b.params[0])!==!0)return c.log(">>>> NO, regex not fullfiled"),!1}else if(a.httpRequest.path!==b.params[0])return c.log(">>>> NO, path differ"),!1;return c.log(">>>> YES"),!0},all:function(a,d){var e={},f=this,g=this.config.some(function(b){if(f._matchPath(b,a)){if("undefined"!=typeof b.httpRequest.query){for(var c in b.httpRequest.query)if("undefined"==typeof a.query[c]||b.httpRequest.query[c].toString()!==a.query[c].toString())return!1;return e=b,!0}return e=b,!0}return!1});g?setTimeout(function(){if(c.log(">>>> match"),"undefined"!=typeof e.httpResponse.headers&&e.httpResponse.headers.forEach(function(a){a.name&&a.value&&d.setHeader(a.name,a.value)}),d.status("undefined"!=typeof e.httpResponse.statusCode?e.httpResponse.statusCode:200),"undefined"!=typeof e.httpResponse.body)d.send(e.httpResponse.body),c.log(">>>> send body");else{c.log(">>>> send a file ?");var f,g=e.httpResponse.bandwidth;"undefined"!=typeof e.httpResponse.file?f=e.httpResponse.file:"undefined"!=typeof e.httpResponse.static&&(f=e.httpResponse.static+a.originalUrl),"undefined"!=typeof f?("undefined"!=typeof g?b._sendfile(f,d,g):d.sendfile(f),c.log(">>>> send "+f)):(c.log(">>>> send nothing"),d.send(""))}},"undefined"==typeof e.httpResponse.delay?1:e.httpResponse.delay):d.send("Not found",404)}};a.routes=d}(this,this.utils),function(a,b,c){"use strict";var d=require("express"),e=require("morgan"),f=require("util"),g=d(),h={_server:null,start:function(a,h,i){g.use(b._allowCrossDomain),g.use(d.json()),g.use(d.urlencoded()),i&&g.use(e("combined")),f.log("start seahorse server on port"+(i?" with logs ":" ")+h);var j=[];if(g.get("/stream",function(a,b){a.socket.setTimeout(1/0),b.writeHead(200,{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}),j.push(b),f.log("[SSE]Â new client registered"),b.write("\n")}),g.post("/stream/:event_name",function(a,b){var c=a.body,d=(new Date).toLocaleTimeString();j.forEach(function(b){b.write("id: "+d+"\n"),b.write("event: "+a.params.event_name+"\n"),b.write("data: "+c+"\n\n")}),b.send(200)}),g.get("/_config",function(a,b){b.setHeader("Content-Type","application/json; charset=utf-8"),b.send(JSON.stringify(c.getConfig()),200)}),g.post("/_config",function(a,b){var d=a.body;c.setConfig(d,g),b.setHeader("Content-Type","application/json; charset=utf-8"),b.send(JSON.stringify(c.getConfig()),200)}),g.put("/_config",function(a,b){var d=a.body;c.updateConfig(d,g),b.setHeader("Content-Type","application/json; charset=utf-8"),b.send(JSON.stringify(c.getConfig()),200)}),"undefined"==typeof a)throw"initial config is undefined";c.setConfig(a,g),g.all("*",function(a,d){b._debug&&f.log("request "+a.method+" "+a.originalUrl),c.all(a,d)}),this._server=g.listen(h)},stop:function(){null!==this._server&&(f.log("stop seahorse server"),this._server.close())}};a.server=h}(this,this.utils,this.routes);